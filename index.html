<!-- Version 3.0 - Doctor Database & Enhanced Notes with Pin Feature -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrayTrack AI - Medical Tray Management</title>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.min.css' rel='stylesheet' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .header {
            background: white;
            padding: 28px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .user-info {
            font-size: 14px;
            color: #6b7280;
            font-weight: 400;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding: 0;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .tab:hover {
            border-color: #6366f1;
            color: #6366f1;
        }

        .tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .tray-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tray-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 2px solid;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .tray-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .tray-card.green { border-color: #34c759; }
        .tray-card.blue { border-color: #007aff; }
        .tray-card.yellow { border-color: #ffcc00; }
        .tray-card.orange { border-color: #ff9500; }
        .tray-card.red { border-color: #ff3b30; }

        .tray-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1f2937;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #111827;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.2s ease;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #6366f1;
            color: white;
        }

        .btn-primary:hover {
            background: #4f46e5;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .error {
            background: #fee;
            color: #c62828;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
        }

        .doctor-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 12px;
            border-left: 4px solid #6366f1;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .doctor-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .doctor-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .doctor-specialty {
            font-size: 14px;
            color: #6366f1;
            margin-bottom: 8px;
        }

        .doctor-contact {
            font-size: 13px;
            color: #6b7280;
        }

        .note-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .note-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .note-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .note-preview {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-pins {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .pin-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #ede9fe;
            color: #6366f1;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .pinned-note {
            background: #fffbeb;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            border-left: 3px solid #f59e0b;
        }

        .pinned-note-title {
            font-size: 14px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 6px;
        }

        .pinned-note-content {
            font-size: 13px;
            color: #78350f;
            white-space: pre-wrap;
        }

        .pin-to-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .pin-to-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .pin-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 6px;
        }

        .pin-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .pin-checkbox label {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>TrayTrack AI</h1>
        <div class="user-info">Rep: <span id="userName">John Smith</span></div>
    </div>

    <!-- PROOF THAT CLAUDE IS MODIFYING YOUR FILES -->
    <div style="background: #ff0000; color: white; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; margin: 20px;">
        üö® CLAUDE MODIFIED THIS FILE! üö® If you see this banner, the changes are working!
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('trays')">My Trays</button>
        <button class="tab" onclick="showTab('doctors')">Doctors</button>
        <button class="tab" onclick="showTab('notes')">Notes</button>
        <button class="tab" onclick="showTab('calendar')">Calendar</button>
        <button class="tab" onclick="showTab('admin')">Admin</button>
    </div>

    <div id="errorMsg" style="display:none;" class="error"></div>
    <div id="successMsg" style="display:none;" class="success"></div>

    <!-- TRAYS TAB -->
    <div id="traysTab">
        <div id="trayList" class="tray-list">
            <div class="loading">Loading trays...</div>
        </div>
    </div>

    <!-- DOCTORS TAB -->
    <div id="doctorsTab" style="display:none;">
        <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" onclick="showCreateDoctorForm()" style="width: auto; padding: 12px 24px;">+ Add Doctor</button>
        </div>
        <div id="doctorList" class="tray-list">
            <div class="loading">Loading doctors...</div>
        </div>
    </div>

    <!-- NOTES TAB -->
    <div id="notesTab" style="display:none;">
        <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" onclick="showCreateNoteForm()" style="width: auto; padding: 12px 24px;">+ Create Note</button>
        </div>
        <div id="noteList" class="tray-list">
            <div class="loading">Loading notes...</div>
        </div>
    </div>

    <!-- CALENDAR TAB -->
    <div id="calendarTab" style="display:none;">
        <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" onclick="showBookCaseForm()" style="width: auto; padding: 12px 24px;">+ Book a Case</button>
        </div>
        <div id="calendar"></div>
    </div>

    <!-- ADMIN TAB -->
    <div id="adminTab" style="display:none;">
        <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
            <h2 style="margin-bottom: 16px;">Create Tray</h2>
            <div class="form-group">
                <label class="form-label">Tray Name</label>
                <input type="text" id="newTrayName" class="form-input" placeholder="e.g., Spine-001">
            </div>
            <button class="btn btn-primary" onclick="createTray()">Create Tray</button>
        </div>

        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
            <h2 style="margin-bottom: 16px;">Add Item to Tray</h2>
            <div class="form-group">
                <label class="form-label">Select Tray</label>
                <select id="itemTraySelect" class="form-select">
                    <option value="">Loading trays...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">SKU</label>
                <input type="text" id="itemSku" class="form-input" placeholder="e.g., SCREW-5MM">
            </div>
            <div class="form-group">
                <label class="form-label">Item Name</label>
                <input type="text" id="itemName" class="form-input" placeholder="e.g., 5mm Screw">
            </div>
            <div class="form-group">
                <label class="form-label">Expected Quantity</label>
                <input type="number" id="itemQtyExpected" class="form-input" placeholder="10">
            </div>
            <div class="form-group">
                <label class="form-label">Current Quantity</label>
                <input type="number" id="itemQtyOnHand" class="form-input" placeholder="10">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="itemCritical">
                    <span>Critical Item</span>
                </label>
            </div>
            <button class="btn btn-primary" onclick="addItem()">Add Item</button>
        </div>
    </div>

    <!-- GENERIC MODAL -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">Modal</div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        const USER_ID = 'rep001';
        let allTrays = [];
        let allDoctors = [];
        let allNotes = [];
        let allCases = [];
        let calendar = null;

        // =========================
        // TAB MANAGEMENT
        // =========================

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('traysTab').style.display = 'none';
            document.getElementById('doctorsTab').style.display = 'none';
            document.getElementById('notesTab').style.display = 'none';
            document.getElementById('calendarTab').style.display = 'none';
            document.getElementById('adminTab').style.display = 'none';

            if (tab === 'trays') {
                document.getElementById('traysTab').style.display = 'block';
                loadTrays();
            } else if (tab === 'doctors') {
                document.getElementById('doctorsTab').style.display = 'block';
                loadDoctors();
            } else if (tab === 'notes') {
                document.getElementById('notesTab').style.display = 'block';
                loadNotes();
            } else if (tab === 'calendar') {
                document.getElementById('calendarTab').style.display = 'block';
                if (!calendar) initializeCalendar();
                loadCalendarEvents();
            } else if (tab === 'admin') {
                document.getElementById('adminTab').style.display = 'block';
                loadTraysForAdmin();
            }
        }

        // =========================
        // TRAY FUNCTIONS
        // =========================

        async function loadTrays() {
            try {
                const response = await fetch(`${API_URL}/trays?sort=priority`);
                allTrays = await response.json();
                renderTrays();
            } catch (error) {
                showError('Failed to load trays');
                console.error(error);
            }
        }

        function renderTrays() {
            const listEl = document.getElementById('trayList');

            if (allTrays.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No trays yet. Use Admin tab to create one.</div>';
                return;
            }

            listEl.innerHTML = allTrays.map(tray => `
                <div class="tray-card ${tray.color}" onclick="openTray(${tray.id})">
                    <div class="tray-name">${tray.name}</div>
                    <div style="font-size: 14px; color: #6b7280;">
                        Status: ${tray.status.replace('_', ' ')}
                    </div>
                    ${tray.items.length > 0 ? `<div style="font-size: 14px; color: #86868b; margin-top: 8px;">${tray.items.length} items</div>` : ''}
                </div>
            `).join('');
        }

        async function openTray(trayId) {
            const tray = allTrays.find(t => t.id === trayId);
            if (!tray) return;

            // Get pinned notes for this tray
            const notesResponse = await fetch(`${API_URL}/trays/${trayId}/notes`);
            const pinnedNotes = await notesResponse.json();

            const itemsHtml = tray.items.length > 0
                ? tray.items.map(item => `
                    <div style="padding: 12px; border-bottom: 1px solid #f5f5f7;">
                        <div style="font-weight: 600;">${item.name}</div>
                        <div style="font-size: 13px; color: #86868b;">
                            SKU: ${item.sku} ‚Ä¢ Stock: ${item.qty_on_hand || 0}/${item.qty_expected || '?'}
                        </div>
                    </div>
                `).join('')
                : '<div style="padding: 12px; color: #86868b;">No items</div>';

            const notesHtml = pinnedNotes.length > 0
                ? '<div style="margin-top: 16px;"><div style="font-weight: 600; margin-bottom: 12px;">üìå Pinned Notes</div>' +
                  pinnedNotes.map(note => `
                    <div class="pinned-note">
                        <div class="pinned-note-title">${note.title}</div>
                        <div class="pinned-note-content">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</div>
                    </div>
                  `).join('') + '</div>'
                : '';

            showModal(
                tray.name,
                `
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 14px; color: #86868b;">Status</div>
                    <div style="font-size: 16px; font-weight: 500; margin-top: 4px;">${tray.status.replace('_', ' ').toUpperCase()}</div>
                </div>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #f5f5f7; border-radius: 8px; margin-bottom: 16px;">
                    ${itemsHtml}
                </div>
                ${notesHtml}
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                `
            );
        }

        // =========================
        // DOCTOR FUNCTIONS
        // =========================

        async function loadDoctors() {
            try {
                const response = await fetch(`${API_URL}/doctors`);
                allDoctors = await response.json();
                renderDoctors();
            } catch (error) {
                showError('Failed to load doctors');
                console.error(error);
            }
        }

        function renderDoctors() {
            const listEl = document.getElementById('doctorList');

            if (allDoctors.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No doctors yet. Click "Add Doctor" to create one.</div>';
                return;
            }

            listEl.innerHTML = allDoctors.map(doctor => `
                <div class="doctor-card" onclick="openDoctor(${doctor.id})">
                    <div class="doctor-name">${doctor.name}</div>
                    ${doctor.specialty ? `<div class="doctor-specialty">${doctor.specialty}</div>` : ''}
                    <div class="doctor-contact">
                        ${doctor.hospital ? `üè• ${doctor.hospital}` : ''}
                        ${doctor.phone ? ` ‚Ä¢ üìû ${doctor.phone}` : ''}
                    </div>
                </div>
            `).join('');
        }

        function showCreateDoctorForm() {
            showModal(
                'Add Doctor',
                `
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="doctorName" class="form-input" placeholder="Dr. John Smith">
                </div>
                <div class="form-group">
                    <label class="form-label">Specialty</label>
                    <input type="text" id="doctorSpecialty" class="form-input" placeholder="Orthopedic Surgery">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="text" id="doctorPhone" class="form-input" placeholder="555-1234">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="doctorEmail" class="form-input" placeholder="doctor@hospital.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Hospital</label>
                    <input type="text" id="doctorHospital" class="form-input" placeholder="St. Mary's Hospital">
                </div>
                <button class="btn btn-primary" onclick="createDoctor()">Add Doctor</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                `
            );
        }

        async function createDoctor() {
            const name = document.getElementById('doctorName').value.trim();
            if (!name) {
                showError('Doctor name is required');
                return;
            }

            const data = {
                name,
                specialty: document.getElementById('doctorSpecialty').value.trim() || null,
                phone: document.getElementById('doctorPhone').value.trim() || null,
                email: document.getElementById('doctorEmail').value.trim() || null,
                hospital: document.getElementById('doctorHospital').value.trim() || null,
            };

            try {
                const response = await fetch(`${API_URL}/doctors`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to create doctor');

                showSuccess('Doctor added successfully!');
                closeModal();
                loadDoctors();
            } catch (error) {
                showError('Failed to create doctor');
                console.error(error);
            }
        }

        async function openDoctor(doctorId) {
            const doctor = allDoctors.find(d => d.id === doctorId);
            if (!doctor) return;

            // Get pinned notes for this doctor
            const notesResponse = await fetch(`${API_URL}/doctors/${doctorId}/notes`);
            const pinnedNotes = await notesResponse.json();

            const notesHtml = pinnedNotes.length > 0
                ? '<div style="margin-top: 16px;"><div style="font-weight: 600; margin-bottom: 12px;">üìå Pinned Notes</div>' +
                  pinnedNotes.map(note => `
                    <div class="pinned-note">
                        <div class="pinned-note-title">${note.title}</div>
                        <div class="pinned-note-content">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</div>
                    </div>
                  `).join('') + '</div>'
                : '';

            showModal(
                doctor.name,
                `
                <div style="margin-bottom: 16px;">
                    ${doctor.specialty ? `<div style="color: #6366f1; font-size: 16px; margin-bottom: 8px;">${doctor.specialty}</div>` : ''}
                    ${doctor.hospital ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">üè• ${doctor.hospital}</div>` : ''}
                    ${doctor.phone ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">üìû ${doctor.phone}</div>` : ''}
                    ${doctor.email ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">‚úâÔ∏è ${doctor.email}</div>` : ''}
                </div>
                ${notesHtml}
                <button class="btn btn-primary" onclick="showEditDoctorForm(${doctorId})">Edit</button>
                <button class="btn btn-danger" onclick="deleteDoctor(${doctorId})">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                `
            );
        }

        function showEditDoctorForm(doctorId) {
            const doctor = allDoctors.find(d => d.id === doctorId);
            if (!doctor) return;

            showModal(
                'Edit Doctor',
                `
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="doctorName" class="form-input" value="${doctor.name}">
                </div>
                <div class="form-group">
                    <label class="form-label">Specialty</label>
                    <input type="text" id="doctorSpecialty" class="form-input" value="${doctor.specialty || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="text" id="doctorPhone" class="form-input" value="${doctor.phone || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="doctorEmail" class="form-input" value="${doctor.email || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Hospital</label>
                    <input type="text" id="doctorHospital" class="form-input" value="${doctor.hospital || ''}">
                </div>
                <button class="btn btn-primary" onclick="updateDoctor(${doctorId})">Save Changes</button>
                <button class="btn btn-secondary" onclick="openDoctor(${doctorId})">Cancel</button>
                `
            );
        }

        async function updateDoctor(doctorId) {
            const name = document.getElementById('doctorName').value.trim();
            if (!name) {
                showError('Doctor name is required');
                return;
            }

            const data = {
                name,
                specialty: document.getElementById('doctorSpecialty').value.trim() || null,
                phone: document.getElementById('doctorPhone').value.trim() || null,
                email: document.getElementById('doctorEmail').value.trim() || null,
                hospital: document.getElementById('doctorHospital').value.trim() || null,
            };

            try {
                const response = await fetch(`${API_URL}/doctors/${doctorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to update doctor');

                showSuccess('Doctor updated successfully!');
                closeModal();
                loadDoctors();
            } catch (error) {
                showError('Failed to update doctor');
                console.error(error);
            }
        }

        async function deleteDoctor(doctorId) {
            if (!confirm('Are you sure you want to delete this doctor? This will also unpin all notes from this doctor.')) return;

            try {
                const response = await fetch(`${API_URL}/doctors/${doctorId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete doctor');

                showSuccess('Doctor deleted successfully!');
                closeModal();
                loadDoctors();
            } catch (error) {
                showError('Failed to delete doctor');
                console.error(error);
            }
        }

        // =========================
        // NOTE FUNCTIONS
        // =========================

        async function loadNotes() {
            try {
                const response = await fetch(`${API_URL}/notes`);
                allNotes = await response.json();
                renderNotes();
            } catch (error) {
                showError('Failed to load notes');
                console.error(error);
            }
        }

        function renderNotes() {
            const listEl = document.getElementById('noteList');

            if (allNotes.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No notes yet. Click "Create Note" to add one.</div>';
                return;
            }

            listEl.innerHTML = allNotes.map(note => {
                const pinsHtml = note.pins.length > 0
                    ? '<div class="note-pins">' + note.pins.map(pin =>
                        `<span class="pin-badge">${pin.entity_type}: ${pin.entity_name || `ID ${pin.entity_id}`}</span>`
                    ).join('') + '</div>'
                    : '';

                return `
                    <div class="note-card" onclick="openNote(${note.id})">
                        <div class="note-title">${note.title}</div>
                        <div class="note-preview">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</div>
                        ${pinsHtml}
                    </div>
                `;
            }).join('');
        }

        async function showCreateNoteForm() {
            // Load all entities for pinning
            await Promise.all([loadTrays(), loadDoctors(), loadCases()]);

            const pinToHtml = `
                <div class="pin-to-section">
                    <div class="pin-to-label">üìå Pin To (Optional)</div>

                    ${allTrays.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Trays</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allTrays.map(tray => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_tray_${tray.id}" value="${tray.id}">
                                    <label for="pin_tray_${tray.id}">${tray.name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${allCases.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Cases</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allCases.map(c => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_case_${c.id}" value="${c.id}">
                                    <label for="pin_case_${c.id}">${c.procedure} - ${new Date(c.case_date).toLocaleDateString()}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${allDoctors.length > 0 ? `
                    <div>
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Doctors</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allDoctors.map(doctor => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_doctor_${doctor.id}" value="${doctor.id}">
                                    <label for="pin_doctor_${doctor.id}">${doctor.name}${doctor.specialty ? ` (${doctor.specialty})` : ''}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            showModal(
                'Create Note',
                `
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="noteTitle" class="form-input" placeholder="Note title">
                </div>
                <div class="form-group">
                    <label class="form-label">Content *</label>
                    <textarea id="noteContent" class="form-textarea" placeholder="Write your note here..."></textarea>
                </div>
                ${pinToHtml}
                <button class="btn btn-primary" onclick="createNote()">Create Note</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                `
            );
        }

        async function createNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title || !content) {
                showError('Title and content are required');
                return;
            }

            // Collect pins
            const pin_to_trays = allTrays.filter(t =>
                document.getElementById(`pin_tray_${t.id}`)?.checked
            ).map(t => t.id);

            const pin_to_cases = allCases.filter(c =>
                document.getElementById(`pin_case_${c.id}`)?.checked
            ).map(c => c.id);

            const pin_to_doctors = allDoctors.filter(d =>
                document.getElementById(`pin_doctor_${d.id}`)?.checked
            ).map(d => d.id);

            const data = {
                title,
                content,
                pin_to_trays: pin_to_trays.length > 0 ? pin_to_trays : null,
                pin_to_cases: pin_to_cases.length > 0 ? pin_to_cases : null,
                pin_to_doctors: pin_to_doctors.length > 0 ? pin_to_doctors : null,
            };

            try {
                const response = await fetch(`${API_URL}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to create note');

                showSuccess('Note created successfully!');
                closeModal();
                loadNotes();
            } catch (error) {
                showError('Failed to create note');
                console.error(error);
            }
        }

        async function openNote(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (!note) return;

            const pinsHtml = note.pins.length > 0
                ? '<div style="margin-top: 16px;"><div style="font-weight: 600; margin-bottom: 8px;">üìå Pinned To:</div>' +
                  note.pins.map(pin => `<span class="pin-badge">${pin.entity_type}: ${pin.entity_name || `ID ${pin.entity_id}`}</span>`).join(' ') +
                  '</div>'
                : '<div style="margin-top: 16px; color: #86868b;">Not pinned to anything</div>';

            showModal(
                note.title,
                `
                <div style="margin-bottom: 16px; white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: #374151;">
                    ${note.content}
                </div>
                ${pinsHtml}
                <div style="font-size: 12px; color: #86868b; margin-top: 16px;">
                    Created: ${new Date(note.created_at).toLocaleString()}
                </div>
                <button class="btn btn-primary" onclick="showEditNoteForm(${noteId})">Edit</button>
                <button class="btn btn-danger" onclick="deleteNote(${noteId})">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                `
            );
        }

        function showEditNoteForm(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (!note) return;

            showModal(
                'Edit Note',
                `
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="noteTitle" class="form-input" value="${note.title}">
                </div>
                <div class="form-group">
                    <label class="form-label">Content *</label>
                    <textarea id="noteContent" class="form-textarea">${note.content}</textarea>
                </div>
                <div style="font-size: 13px; color: #6b7280; margin-top: 12px;">
                    Note: Use the pin/unpin buttons in the note details to manage pins.
                </div>
                <button class="btn btn-primary" onclick="updateNote(${noteId})">Save Changes</button>
                <button class="btn btn-secondary" onclick="openNote(${noteId})">Cancel</button>
                `
            );
        }

        async function updateNote(noteId) {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title || !content) {
                showError('Title and content are required');
                return;
            }

            const data = { title, content };

            try {
                const response = await fetch(`${API_URL}/notes/${noteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to update note');

                showSuccess('Note updated successfully!');
                closeModal();
                loadNotes();
            } catch (error) {
                showError('Failed to update note');
                console.error(error);
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;

            try {
                const response = await fetch(`${API_URL}/notes/${noteId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete note');

                showSuccess('Note deleted successfully!');
                closeModal();
                loadNotes();
            } catch (error) {
                showError('Failed to delete note');
                console.error(error);
            }
        }

        // =========================
        // CALENDAR FUNCTIONS
        // =========================

        async function loadCases() {
            try {
                const response = await fetch(`${API_URL}/cases`);
                allCases = await response.json();
            } catch (error) {
                console.error('Failed to load cases:', error);
            }
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                timeZone: 'local',
                events: [],
                eventClick: function(info) {
                    showCaseDetails(info.event);
                },
                height: 'auto'
            });

            calendar.render();
        }

        async function loadCalendarEvents() {
            try {
                await loadCases();

                const events = allCases.map(c => ({
                    id: c.id,
                    title: c.procedure,
                    start: c.case_date,
                    extendedProps: {
                        location: c.location,
                        doctor: c.doctor,
                        tray_name: c.tray_name,
                        tray_other: c.tray_other,
                        notes: c.notes,
                        user_id: c.user_id
                    },
                    backgroundColor: '#6366f1',
                    borderColor: '#6366f1'
                }));

                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                }
            } catch (error) {
                showError('Failed to load calendar events');
                console.error(error);
            }
        }

        function showCaseDetails(event) {
            showModal(
                'Case Details',
                `
                <div style="font-size: 14px; line-height: 1.6;">
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; color: #1d1d1f;">Procedure</div>
                        <div style="color: #6b7280;">${event.title}</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; color: #1d1d1f;">Date & Time</div>
                        <div style="color: #6b7280;">${new Date(event.start).toLocaleString()}</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; color: #1d1d1f;">Location</div>
                        <div style="color: #6b7280;">${event.extendedProps.location}</div>
                    </div>
                    ${event.extendedProps.tray_name || event.extendedProps.tray_other ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; color: #1d1d1f;">Tray</div>
                        <div style="color: #6b7280;">${event.extendedProps.tray_name || event.extendedProps.tray_other}</div>
                    </div>
                    ` : ''}
                    ${event.extendedProps.notes ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; color: #1d1d1f;">Notes</div>
                        <div style="color: #6b7280;">${event.extendedProps.notes}</div>
                    </div>
                    ` : ''}
                </div>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                `
            );
        }

        function showBookCaseForm() {
            showModal(
                'Book a Case',
                `
                <div class="form-group">
                    <label class="form-label">Procedure *</label>
                    <input type="text" id="caseProcedure" class="form-input" placeholder="e.g., Spinal Fusion">
                </div>
                <div class="form-group">
                    <label class="form-label">Date & Time *</label>
                    <input type="datetime-local" id="caseDateTime" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Location *</label>
                    <input type="text" id="caseLocation" class="form-input" placeholder="e.g., St. Mary's Hospital">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="caseNotes" class="form-textarea" rows="3" placeholder="Any additional notes"></textarea>
                </div>
                <button class="btn btn-primary" onclick="createCase()">Book Case</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                `
            );
        }

        async function createCase() {
            const procedure = document.getElementById('caseProcedure').value.trim();
            const dateTime = document.getElementById('caseDateTime').value;
            const location = document.getElementById('caseLocation').value.trim();
            const notes = document.getElementById('caseNotes').value.trim();

            if (!procedure || !dateTime || !location) {
                showError('Please fill in all required fields');
                return;
            }

            const data = {
                procedure,
                case_date: dateTime + ':00',
                location,
                doctor: null,
                tray_id: null,
                tray_other: null,
                notes: notes || null
            };

            try {
                const response = await fetch(`${API_URL}/cases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to book case');

                showSuccess('Case booked successfully!');
                closeModal();
                loadCalendarEvents();
            } catch (error) {
                showError('Failed to book case');
                console.error(error);
            }
        }

        // =========================
        // ADMIN FUNCTIONS
        // =========================

        async function loadTraysForAdmin() {
            try {
                const response = await fetch(`${API_URL}/trays`);
                const trays = await response.json();

                const select = document.getElementById('itemTraySelect');
                select.innerHTML = '<option value="">Select a tray...</option>' +
                    trays.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            } catch (error) {
                console.error(error);
            }
        }

        async function createTray() {
            const name = document.getElementById('newTrayName').value.trim();
            if (!name) {
                showError('Please enter a tray name');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/seed/trays`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to create tray');
                }

                showSuccess(`Tray "${name}" created!`);
                document.getElementById('newTrayName').value = '';
                loadTraysForAdmin();
            } catch (error) {
                showError(error.message);
            }
        }

        async function addItem() {
            const trayId = document.getElementById('itemTraySelect').value;
            const sku = document.getElementById('itemSku').value.trim();
            const name = document.getElementById('itemName').value.trim();
            const qtyExpected = parseInt(document.getElementById('itemQtyExpected').value) || null;
            const qtyOnHand = parseInt(document.getElementById('itemQtyOnHand').value) || null;
            const isCritical = document.getElementById('itemCritical').checked;

            if (!trayId || !sku || !name) {
                showError('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/seed/tray-items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tray_id: parseInt(trayId),
                        sku,
                        name,
                        qty_expected: qtyExpected,
                        qty_on_hand: qtyOnHand,
                        is_critical: isCritical
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to add item');
                }

                showSuccess(`Item "${name}" added!`);
                document.getElementById('itemSku').value = '';
                document.getElementById('itemName').value = '';
                document.getElementById('itemQtyExpected').value = '';
                document.getElementById('itemQtyOnHand').value = '';
                document.getElementById('itemCritical').checked = false;
            } catch (error) {
                showError(error.message);
            }
        }

        // =========================
        // MODAL & UTILITY FUNCTIONS
        // =========================

        function showModal(title, body) {
            document.getElementById('modalHeader').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // Initialize on page load
        loadTrays();
    </script>
</body>
</html>

